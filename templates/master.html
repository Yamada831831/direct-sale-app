{% extends 'base.html' %}

{% block title %}ãƒã‚¹ã‚¿ç®¡ç†{% endblock %}

{% block content %}
<h2>ğŸ“¦ è¦æ ¼ãƒã‚¹ã‚¿ç®¡ç†</h2>

<form id="standard-form">
    <label>è¦æ ¼åï¼š</label>
    <input type="text" name="name" required>
    <label>ä½¿ç”¨é‡ï¼ˆä¾‹ï¼š0.2ï¼‰</label>
    <input type="number" name="usage_ratio" step="0.01" required>
    <button type="submit">è¿½åŠ </button>
</form>

<ul id="standard-list"></ul>

<hr>

<h2>ğŸ’° åŸä¾¡ãƒã‚¹ã‚¿ç®¡ç†</h2>

<form id="cost-form">
    <label>å•†å“åï¼š</label>
    <input type="text" name="product_name" required>
    <label>é€±é–‹å§‹æ—¥ï¼ˆæœˆæ›œï¼‰</label>
    <input type="date" name="week_start" required>
    <label>1kgã¾ãŸã¯1pkã‚ãŸã‚Šã®åŸä¾¡ï¼ˆå††ï¼‰</label>
    <input type="number" name="cost_per_unit" step="0.01" required>
    <button type="submit">è¿½åŠ  / ä¸Šæ›¸ã</button>
</form>

<ul id="cost-list"></ul>

<script>
    const standardForm = document.getElementById('standard-form');
    const standardList = document.getElementById('standard-list');

    const costForm = document.getElementById('cost-form');
    const costList = document.getElementById('cost-list');

    // ---------------------
    // è¦æ ¼ãƒã‚¹ã‚¿ã®å‡¦ç†
    // ---------------------
    async function loadStandards() {
        const res = await fetch('/api/master/standards');
        const data = await res.json();
        standardList.innerHTML = '';
        data.forEach(item => {
            const li = document.createElement('li');
            li.textContent = `${item.name}ï¼ˆä½¿ç”¨é‡ï¼š${item.usage_ratio}ï¼‰ `;
            const delBtn = document.createElement('button');
            delBtn.textContent = 'å‰Šé™¤';
            delBtn.onclick = async () => {
                await fetch(`/api/master/standards?name=${encodeURIComponent(item.name)}`, { method: 'DELETE' });
                loadStandards();
            };
            li.appendChild(delBtn);
            standardList.appendChild(li);
        });
    }

    standardForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(standardForm);
        await fetch('/api/master/standards', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: formData.get('name'),
                usage_ratio: formData.get('usage_ratio')
            })
        });
        standardForm.reset();
        loadStandards();
    });

    // ---------------------
    // åŸä¾¡ãƒã‚¹ã‚¿ã®å‡¦ç†
    // ---------------------
    async function loadCosts() {
        const res = await fetch('/api/master/costs');
        const data = await res.json();
        costList.innerHTML = '';
        data.forEach(item => {
            const li = document.createElement('li');
            li.textContent = `${item.product_name} / ${item.week_start}ï¼šï¿¥${item.cost_per_unit} `;
            const delBtn = document.createElement('button');
            delBtn.textContent = 'å‰Šé™¤';
            delBtn.onclick = async () => {
                await fetch(`/api/master/costs?product_name=${encodeURIComponent(item.product_name)}&week_start=${item.week_start}`, {
                    method: 'DELETE'
                });
                loadCosts();
            };
            li.appendChild(delBtn);
            costList.appendChild(li);
        });
    }

    costForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(costForm);
        await fetch('/api/master/costs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                product_name: formData.get('product_name'),
                week_start: formData.get('week_start'),
                cost_per_unit: formData.get('cost_per_unit')
            })
        });
        costForm.reset();
        loadCosts();
    });

    loadStandards();
    loadCosts();
</script>
{% endblock %}
